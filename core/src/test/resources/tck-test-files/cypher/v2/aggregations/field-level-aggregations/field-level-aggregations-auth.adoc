:toc:

= Field Level Aggregations

== Source schema

[source,graphql,schema=true]
----
type Movie @auth(rules: [{isAuthenticated: true}]) {
  title: String
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
}

type Actor {
  name: String
  age: Int
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Count aggregation with auth in aggregated node

.GraphQL-Query
[source,graphql]
----
{
  actors {
    name
    moviesAggregate {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
RETURN this { .name, moviesAggregate: { count: head(apoc.cypher.runFirstColumn("MATCH (this)-[r:ACTED_IN]->(n:Movie)     CALL apoc.util.validate(NOT(apoc.util.validatePredicate(NOT($auth.isAuthenticated = true), \"@neo4j/graphql/UNAUTHENTICATED\", [0])), \"@neo4j/graphql/FORBIDDEN\", [0]) RETURN COUNT(n)", { auth: $auth, this: this })) } } as this
----

'''

== Count aggregation with parent node auth

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actorsAggregate {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": [],
      "sub": "super_admin"
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL apoc.util.validate(NOT(apoc.util.validatePredicate(NOT($auth.isAuthenticated = true), "@neo4j/graphql/UNAUTHENTICATED", [0])), "@neo4j/graphql/FORBIDDEN", [0])
RETURN this { .title, actorsAggregate: { count: head(apoc.cypher.runFirstColumn("MATCH (this)<-[r:ACTED_IN]-(n:Actor)      RETURN COUNT(n)", { this: this })) } } as this
----

'''

