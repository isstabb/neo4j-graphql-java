:toc:

= Cypher Aggregations with Auth

== Source schema

[source,graphql,schema=true]
----
type User {
  id: ID @auth(rules: [{allow: {id: "$jwt.sub"}}])
  name: String! @auth(rules: [{allow: {id: "$jwt.sub"}}])
  imdbRatingInt: Int! @auth(rules: [{allow: {id: "$jwt.sub"}}])
  imdbRatingFloat: Float! @auth(rules: [{allow: {id: "$jwt.sub"}}])
  imdbRatingBigInt: BigInt! @auth(rules: [{allow: {id: "$jwt.sub"}}])
  createdAt: DateTime @auth(rules: [{allow: {id: "$jwt.sub"}}])
}

extend type User @auth(rules: [{allow: {id: "$jwt.sub"}, where: {id: "$jwt.sub"}}])
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
}
----
== Count with WHERE

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate(where: {name: "some-name"}) {
    count
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_name": "some-name",
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.name = $this_name AND this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { count: count(this) }
----

== Field BigInt with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    imdbRatingBigInt {
      min
      max
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin",
  "imdbRatingBigInt_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $imdbRatingBigInt_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { imdbRatingBigInt: { min: min(this.imdbRatingBigInt), max: max(this.imdbRatingBigInt) } }
----

== Field DateTime with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    createdAt {
      min
      max
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin",
  "createdAt_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $createdAt_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { createdAt: { min: apoc.date.convertFormat(toString(min(this.createdAt)), "iso_zoned_date_time", "iso_offset_date_time"), max: apoc.date.convertFormat(toString(max(this.createdAt)), "iso_zoned_date_time", "iso_offset_date_time") } }
----

== Field Float with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    imdbRatingFloat {
      min
      max
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin",
  "imdbRatingFloat_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $imdbRatingFloat_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { imdbRatingFloat: { min: min(this.imdbRatingFloat), max: max(this.imdbRatingFloat) } }
----

== Field ID with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    id {
      shortest
      longest
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin",
  "id_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $id_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { id: { shortest: min(this.id), longest: max(this.id) } }
----

== Field Int with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    imdbRatingInt {
      min
      max
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin",
  "imdbRatingInt_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $imdbRatingInt_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { imdbRatingInt: { min: min(this.imdbRatingInt), max: max(this.imdbRatingInt) } }
----

== Field String with auth

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    name {
      shortest
      longest
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin",
  "name_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $name_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { name: { shortest: 
                            reduce(shortest = collect(this.name)[0], current IN collect(this.name) | apoc.cypher.runFirstColumn("
                                RETURN
                                CASE size(current) < size(shortest)
                                WHEN true THEN current
                                ELSE shortest
                                END AS result
                            ", { current: current, shortest: shortest }, false))
                        , longest: 
                            reduce(shortest = collect(this.name)[0], current IN collect(this.name) | apoc.cypher.runFirstColumn("
                                RETURN
                                CASE size(current) > size(shortest)
                                WHEN true THEN current
                                ELSE shortest
                                END AS result
                            ", { current: current, shortest: shortest }, false))
                         } }
----

== Simple Count

.GraphQL-Query
[source,graphql]
----
{
  usersAggregate {
    count
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_auth_where0_id": "super_admin",
  "this_auth_allow0_id": "super_admin"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.id IS NOT NULL AND this.id = $this_auth_where0_id
CALL apoc.util.validate(NOT(this.id IS NOT NULL AND this.id = $this_auth_allow0_id), "@neo4j/graphql/FORBIDDEN", [0])
RETURN { count: count(this) }
----

