:toc:

= Field Level Aggregations Where

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN)
  directors: [Person!]! @relationship(type: "DIRECTED", direction: IN)
  released: DateTime
}

type Person {
  name: String
  age: Int
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Count aggregation with colliding filter

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actorsAggregate(where: {name_CONTAINS: "abc"}) {
      count
    }
    directorsAggregate(where: {name_CONTAINS: "abcdefg"}) {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorsAggregate_param0": "abc",
  "this_directorsAggregate_param0": "abcdefg"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	MATCH (this_actorsAggregate_this1:Person)-[this_actorsAggregate_this0:ACTED_IN]->(this)
	WHERE this_actorsAggregate_this1.name CONTAINS $this_actorsAggregate_param0
	RETURN count(this) AS this_actorsAggregate_var2
}
CALL {
	WITH this
	MATCH (this_directorsAggregate_this1:Person)-[this_directorsAggregate_this0:DIRECTED]->(this)
	WHERE this_directorsAggregate_this1.name CONTAINS $this_directorsAggregate_param0
	RETURN count(this) AS this_directorsAggregate_var2
}
RETURN this {
	.title,
	actorsAggregate: {
		count: this_actorsAggregate_var2
	},
	directorsAggregate: {
		count: this_directorsAggregate_var2
	}
} AS this
----

'''

== Count aggregation with number filter

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actorsAggregate(where: {age_GT: 40}) {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorsAggregate_param0": {
    "low": 40,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	MATCH (this_actorsAggregate_this1:Person)-[this_actorsAggregate_this0:ACTED_IN]->(this)
	WHERE this_actorsAggregate_this1.age > $this_actorsAggregate_param0
	RETURN count(this) AS this_actorsAggregate_var2
}
RETURN this {
	.title,
	actorsAggregate: {
		count: this_actorsAggregate_var2
	}
} AS this
----

'''

