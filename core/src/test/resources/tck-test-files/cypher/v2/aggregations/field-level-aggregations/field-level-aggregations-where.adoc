:toc:

= Field Level Aggregations Where

== Source schema

[source,graphql,schema=true]
----
type Movie {
  title: String
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN)
  directors: [Person!]! @relationship(type: "DIRECTED", direction: IN)
  released: DateTime
}

type Person {
  name: String
  age: Int
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
}
----
== Count aggregation with colliding filter

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actorsAggregate(where: {name_CONTAINS: "abc"}) {
      count
    }
    directorsAggregate(where: {name_CONTAINS: "abcdefg"}) {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorsAggregate_n_name_CONTAINS": "abc",
  "this_directorsAggregate_n_name_CONTAINS": "abcdefg"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
RETURN this { .title, actorsAggregate: { count: head(apoc.cypher.runFirstColumn("MATCH (this)<-[r:ACTED_IN]-(n:Person) WHERE n.name CONTAINS $this_actorsAggregate_n_name_CONTAINS    RETURN COUNT(n)", { this_actorsAggregate_n_name_CONTAINS: $this_actorsAggregate_n_name_CONTAINS, this: this })) }, directorsAggregate: { count: head(apoc.cypher.runFirstColumn("MATCH (this)<-[r:DIRECTED]-(n:Person) WHERE n.name CONTAINS $this_directorsAggregate_n_name_CONTAINS    RETURN COUNT(n)", { this_directorsAggregate_n_name_CONTAINS: $this_directorsAggregate_n_name_CONTAINS, this: this })) } } as this
----

== Count aggregation with number filter

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    actorsAggregate(where: {age_GT: 40}) {
      count
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorsAggregate_n_age_GT": {
    "low": 40,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
RETURN this { .title, actorsAggregate: { count: head(apoc.cypher.runFirstColumn("MATCH (this)<-[r:ACTED_IN]-(n:Person) WHERE n.age > $this_actorsAggregate_n_age_GT    RETURN COUNT(n)", { this_actorsAggregate_n_age_GT: $this_actorsAggregate_n_age_GT, this: this })) } } as this
----

