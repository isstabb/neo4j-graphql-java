:toc:

= Subscriptions metadata on create

== Source schema

[source,graphql,schema=true]
----
type Actor {
  name: String!
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}

type Movie {
  id: ID!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Multi Create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(input: [{id: "1"}, {id: "2"}]) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_id": "1",
  "this1_id": "2"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	WITH [] AS meta
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	WITH (meta + {
		event: 'create',
		id: id(this0),
		properties: {
			old: NULL,
			new: this0 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0
	RETURN this0, meta AS this0_meta
}
CALL {
	WITH [] AS meta
	CREATE (this1:Movie)
	SET this1.id = $this1_id
	WITH (meta + {
		event: 'create',
		id: id(this1),
		properties: {
			old: NULL,
			new: this1 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this1
	RETURN this1, meta AS this1_meta
}
WITH this0, this1, (this0_meta + this1_meta) AS meta
RETURN [this0 {
	.id
}, this1 {
	.id
}] AS data, meta
----

'''

== Multi Create with nested

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: "1", actors: {create: {node: {name: "Andrés", movies: {create: {node: {id: 6}}}}}}}, {id: "2", actors: {create: {node: {name: "Darrell", movies: {create: {node: {id: 8}}}}}}}]
  ) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_id": "1",
  "this0_actors0_node_name": "Andrés",
  "this0_actors0_node_movies0_node_id": "6",
  "this1_id": "2",
  "this1_actors0_node_name": "Darrell",
  "this1_actors0_node_movies0_node_id": "8"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	WITH [] AS meta
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	CREATE (this0_actors0_node:Actor)
	SET this0_actors0_node.name = $this0_actors0_node_name
	CREATE (this0_actors0_node_movies0_node:Movie)
	SET this0_actors0_node_movies0_node.id = $this0_actors0_node_movies0_node_id
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node_movies0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node_movies0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0, this0_actors0_node, this0_actors0_node_movies0_node
	MERGE (this0_actors0_node)-[:ACTED_IN]->(this0_actors0_node_movies0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Actor'
	}) AS meta, this0, this0_actors0_node
	MERGE (this0)<-[:ACTED_IN]-(this0_actors0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0),
		properties: {
			old: NULL,
			new: this0 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0
	RETURN this0, meta AS this0_meta
}
CALL {
	WITH [] AS meta
	CREATE (this1:Movie)
	SET this1.id = $this1_id
	CREATE (this1_actors0_node:Actor)
	SET this1_actors0_node.name = $this1_actors0_node_name
	CREATE (this1_actors0_node_movies0_node:Movie)
	SET this1_actors0_node_movies0_node.id = $this1_actors0_node_movies0_node_id
	WITH (meta + {
		event: 'create',
		id: id(this1_actors0_node_movies0_node),
		properties: {
			old: NULL,
			new: this1_actors0_node_movies0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this1, this1_actors0_node, this1_actors0_node_movies0_node
	MERGE (this1_actors0_node)-[:ACTED_IN]->(this1_actors0_node_movies0_node)
	WITH (meta + {
		event: 'create',
		id: id(this1_actors0_node),
		properties: {
			old: NULL,
			new: this1_actors0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Actor'
	}) AS meta, this1, this1_actors0_node
	MERGE (this1)<-[:ACTED_IN]-(this1_actors0_node)
	WITH (meta + {
		event: 'create',
		id: id(this1),
		properties: {
			old: NULL,
			new: this1 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this1
	RETURN this1, meta AS this1_meta
}
WITH this0, this1, (this0_meta + this1_meta) AS meta
RETURN [this0 {
	.id
}, this1 {
	.id
}] AS data, meta
----

'''

== Nested Create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(input: [{id: "1", actors: {create: {node: {name: "Andrés"}}}}]) {
    movies {
      id
      actors {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_id": "1",
  "this0_actors0_node_name": "Andrés"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	WITH [] AS meta
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	CREATE (this0_actors0_node:Actor)
	SET this0_actors0_node.name = $this0_actors0_node_name
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Actor'
	}) AS meta, this0, this0_actors0_node
	MERGE (this0)<-[:ACTED_IN]-(this0_actors0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0),
		properties: {
			old: NULL,
			new: this0 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0
	RETURN this0, meta AS this0_meta
}
WITH this0, this0_meta AS meta
RETURN [this0 {
	.id,
	actors: [(this0)<-[:ACTED_IN]-(this0_actors:Actor) | this0_actors {
		.name
	}]
}] AS data, meta
----

'''

== Quadruple nested Create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: "1", actors: {create: {node: {name: "Andrés", movies: {create: {node: {id: 6, actors: {create: {node: {name: "Thomas"}}}}}}}}}}]
  ) {
    movies {
      id
      actors {
        name
        movies {
          id
          actors {
            name
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_id": "1",
  "this0_actors0_node_name": "Andrés",
  "this0_actors0_node_movies0_node_id": "6",
  "this0_actors0_node_movies0_node_actors0_node_name": "Thomas"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	WITH [] AS meta
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	CREATE (this0_actors0_node:Actor)
	SET this0_actors0_node.name = $this0_actors0_node_name
	CREATE (this0_actors0_node_movies0_node:Movie)
	SET this0_actors0_node_movies0_node.id = $this0_actors0_node_movies0_node_id
	CREATE (this0_actors0_node_movies0_node_actors0_node:Actor)
	SET this0_actors0_node_movies0_node_actors0_node.name = $this0_actors0_node_movies0_node_actors0_node_name
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node_movies0_node_actors0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node_movies0_node_actors0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Actor'
	}) AS meta, this0, this0_actors0_node, this0_actors0_node_movies0_node, this0_actors0_node_movies0_node_actors0_node
	MERGE (this0_actors0_node_movies0_node)<-[:ACTED_IN]-(this0_actors0_node_movies0_node_actors0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node_movies0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node_movies0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0, this0_actors0_node, this0_actors0_node_movies0_node
	MERGE (this0_actors0_node)-[:ACTED_IN]->(this0_actors0_node_movies0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Actor'
	}) AS meta, this0, this0_actors0_node
	MERGE (this0)<-[:ACTED_IN]-(this0_actors0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0),
		properties: {
			old: NULL,
			new: this0 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0
	RETURN this0, meta AS this0_meta
}
WITH this0, this0_meta AS meta
RETURN [this0 {
	.id,
	actors: [(this0)<-[:ACTED_IN]-(this0_actors:Actor) | this0_actors {
		.name,
		movies: [(this0_actors)-[:ACTED_IN]->(this0_actors_movies:Movie) | this0_actors_movies {
			.id,
			actors: [(this0_actors_movies)<-[:ACTED_IN]-(this0_actors_movies_actors:Actor) | this0_actors_movies_actors {
				.name
			}]
		}]
	}]
}] AS data, meta
----

'''

== Simple Create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(input: [{id: "1"}]) {
    movies {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_id": "1"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	WITH [] AS meta
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	WITH (meta + {
		event: 'create',
		id: id(this0),
		properties: {
			old: NULL,
			new: this0 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0
	RETURN this0, meta AS this0_meta
}
WITH this0, this0_meta AS meta
RETURN [this0 {
	.id
}] AS data, meta
----

'''

== Simple create without returned data

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(input: [{id: "1"}]) {
    info {
      nodesCreated
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_id": "1"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	WITH [] AS meta
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	WITH (meta + {
		event: 'create',
		id: id(this0),
		properties: {
			old: NULL,
			new: this0 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0
	RETURN this0, meta AS this0_meta
}
WITH this0, this0_meta AS meta
RETURN meta
----

'''

== Triple nested Create

.GraphQL-Query
[source,graphql]
----
mutation {
  createMovies(
    input: [{id: "1", actors: {create: {node: {name: "Andrés", movies: {create: {node: {id: 6}}}}}}}]
  ) {
    movies {
      id
      actors {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this0_id": "1",
  "this0_actors0_node_name": "Andrés",
  "this0_actors0_node_movies0_node_id": "6"
}
----

.Expected Cypher output
[source,cypher]
----
CALL {
	WITH [] AS meta
	CREATE (this0:Movie)
	SET this0.id = $this0_id
	CREATE (this0_actors0_node:Actor)
	SET this0_actors0_node.name = $this0_actors0_node_name
	CREATE (this0_actors0_node_movies0_node:Movie)
	SET this0_actors0_node_movies0_node.id = $this0_actors0_node_movies0_node_id
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node_movies0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node_movies0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0, this0_actors0_node, this0_actors0_node_movies0_node
	MERGE (this0_actors0_node)-[:ACTED_IN]->(this0_actors0_node_movies0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0_actors0_node),
		properties: {
			old: NULL,
			new: this0_actors0_node {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Actor'
	}) AS meta, this0, this0_actors0_node
	MERGE (this0)<-[:ACTED_IN]-(this0_actors0_node)
	WITH (meta + {
		event: 'create',
		id: id(this0),
		properties: {
			old: NULL,
			new: this0 {
				.*
			}
		},
		timestamp: timestamp(),
		typename: 'Movie'
	}) AS meta, this0
	RETURN this0, meta AS this0_meta
}
WITH this0, this0_meta AS meta
RETURN [this0 {
	.id,
	actors: [(this0)<-[:ACTED_IN]-(this0_actors:Actor) | this0_actors {
		.name
	}]
}] AS data, meta
----

'''

