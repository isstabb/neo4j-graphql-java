:toc:

= https://github.com/neo4j/graphql/issues/1249

== Source schema

[source,graphql,schema=true]
----
type Bulk @exclude(operations: [CREATE, DELETE, UPDATE]) @node(additionalLabels: ["$context.cypherParams.tenant"]) {
  id: ID!
  supplierMaterialNumber: String!
  material: Material! @relationship(type: "MATERIAL_BULK", direction: OUT)
}

type Material @exclude(operations: [CREATE, DELETE, UPDATE]) {
  id: ID!
  itemNumber: String!
  suppliers: [Supplier!]! @relationship(type: "MATERIAL_SUPPLIER", properties: "RelationMaterialSupplier", direction: OUT)
}

type Supplier @exclude(operations: [CREATE, DELETE, UPDATE]) {
  id: ID!
  name: String
  supplierId: String!
}

interface RelationMaterialSupplier @relationshipProperties {
  supplierMaterialNumber: String!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== should contain the cypherParams that are passed via the context

.GraphQL-Query
[source,graphql]
----
{
  bulks {
    supplierMaterialNumber
    material {
      id
      suppliersConnection {
        edges {
          supplierMaterialNumber
          node {
            supplierId
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "cypherParams" : {
    "tenant" : "BULK"
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Bulk:BULK)
CALL {
	WITH this
	MATCH (this)-[this0:MATERIAL_BULK]->(this_material:Material)
	CALL {
		WITH this_material
		MATCH (this_material)-[this_material_connection_suppliersConnectionthis0:MATERIAL_SUPPLIER]->(this_material_Supplier:Supplier)
		WITH {
			supplierMaterialNumber: this_material_connection_suppliersConnectionthis0.supplierMaterialNumber,
			node: {
				supplierId: this_material_Supplier.supplierId
			}
		} AS edge
		WITH collect(edge) AS edges
		WITH edges, size(edges) AS totalCount
		RETURN {
			edges: edges,
			totalCount: totalCount
		} AS this_material_suppliersConnection
	}
	WITH this_material {
		.id,
		suppliersConnection: this_material_suppliersConnection
	} AS this_material
	RETURN head(collect(this_material)) AS this_material
}
RETURN this {
	.supplierMaterialNumber,
	material: this_material
} AS this
----

'''

