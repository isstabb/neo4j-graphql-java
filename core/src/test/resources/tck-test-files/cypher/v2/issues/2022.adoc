:toc:

= https://github.com/neo4j/graphql/issues/2022

== Source schema

[source,graphql,schema=true]
----
type ArtPiece {
  dbId: ID! @id(global: true) @alias(property: "id")
  title: String!
  auction: AuctionItem! @relationship(type: "SOLD_AT_AUCTION_AS", direction: OUT)
  owner: Organization! @relationship(type: "OWNED_BY", direction: OUT)
}

type AuctionItem {
  dbId: ID! @id(global: true) @alias(property: "id")
  auctionName: String!
  lotNumber: Int!
  item: ArtPiece! @relationship(type: "SOLD_AT_AUCTION_AS", direction: IN)
  buyer: Organization! @relationship(type: "BOUGHT_ITEM_AT_AUCTION", direction: IN)
  seller: Organization! @relationship(type: "SOLD_ITEM_AT_AUCTION", direction: IN)
}

type Organization {
  dbId: ID! @id(global: true) @alias(property: "id")
  name: String!
  artCollection: [ArtPiece!]! @relationship(type: "OWNED_BY", direction: IN)
  itemsSoldAtAuction: [AuctionItem!]! @relationship(type: "SOLD_ITEM_AT_AUCTION", direction: OUT)
  itemsBoughtAtAuction: [AuctionItem!]! @relationship(type: "BOUGHT_ITEM_AT_AUCTION", direction: OUT)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== query nested relations under a root connection field

.GraphQL-Query
[source,graphql]
----
{
  artPiecesConnection {
    totalCount
    edges {
      node {
        id
        title
        auction {
          id
          auctionName
          lotNumber
          buyer {
            id
            name
          }
        }
        owner {
          id
          name
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:`ArtPiece`)
WITH collect(this) AS edges
WITH edges, size(edges) AS totalCount
UNWIND edges AS this
WITH this, totalCount

CALL {
    WITH this
    MATCH (this)-[this0:SOLD_AT_AUCTION_AS]->(this_auction:`AuctionItem`)
    CALL {
        WITH this_auction
        MATCH (this_auction_buyer:`Organization`)-[this1:BOUGHT_ITEM_AT_AUCTION]->(this_auction)
        WITH this_auction_buyer { .name, dbId: this_auction_buyer.id } AS this_auction_buyer
        RETURN head(collect(this_auction_buyer)) AS this_auction_buyer
    }
    WITH this_auction { .auctionName, .lotNumber, buyer: this_auction_buyer, dbId: this_auction.id } AS this_auction
    RETURN head(collect(this_auction)) AS this_auction
}
CALL {
    WITH this
    MATCH (this)-[this2:OWNED_BY]->(this_owner:`Organization`)
    WITH this_owner { .name, dbId: this_owner.id } AS this_owner
    RETURN head(collect(this_owner)) AS this_owner
}
WITH { node: this { .title, auction: this_auction, owner: this_owner, dbId: this.id } } AS edge, totalCount, this
WITH collect(edge) AS edges, totalCount
RETURN { edges: edges, totalCount: totalCount } AS this
----

'''

