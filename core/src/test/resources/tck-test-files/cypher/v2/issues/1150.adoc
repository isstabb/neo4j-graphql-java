:toc:

= https://github.com/neo4j/graphql/issues/1150

== Source schema

[source,graphql,schema=true]
----
type Battery {
  id: ID! @id(autogenerate: false)
  current: Boolean!
}

extend type Battery @auth(rules: [{isAuthenticated: true, roles: ["admin"]}])

type CombustionEngine {
  id: ID! @id(autogenerate: false)
  current: Boolean!
}

type Drive {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  driveCompositions: [DriveComposition!]! @relationship(type: "CONSISTS_OF", properties: "RelationProps", direction: OUT)
}

union DriveComponent = Battery | CombustionEngine

type DriveComposition {
  id: ID! @id(autogenerate: false)
  current: Boolean!
  driveComponent: [DriveComponent!]! @relationship(type: "HAS", properties: "RelationProps", direction: OUT)
}

interface RelationProps {
  current: Boolean!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== union types with auth and connection-where

.GraphQL-Query
[source,graphql]
----
query getDrivesWithFilteredUnionType {
  drives(where: {current: true}) {
    current
    driveCompositionsConnection(where: {edge: {current: true}}) {
      edges {
        node {
          driveComponentConnection(
            where: {Battery: {edge: {current: true}}, CombustionEngine: {edge: {current: true}}}
          ) {
            edges {
              current
              node {
                ... on Battery {
                  id
                }
                ... on CombustionEngine {
                  id
                }
              }
            }
          }
        }
      }
    }
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "contextParams": {
    "jwt": {
      "roles": [
        "admin"
      ]
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_current": true,
  "this_driveCompositionsConnection": {
    "args": {
      "where": {
        "edge": {
          "current": true
        }
      }
    },
    "edges": {
      "node": {
        "driveComponentConnection": {
          "args": {
            "where": {
              "Battery": {
                "edge": {
                  "current": true
                }
              },
              "CombustionEngine": {
                "edge": {
                  "current": true
                }
              }
            }
          }
        }
      }
    }
  },
  "auth": {
    "isAuthenticated": true,
    "roles": [
      "admin"
    ],
    "jwt": {
      "roles": [
        "admin"
      ]
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Drive)
WHERE this.current = $this_current
CALL {
WITH this
MATCH (this)-[this_consists_of_relationship:CONSISTS_OF]->(this_drivecomposition:DriveComposition)
WHERE this_consists_of_relationship.current = $this_driveCompositionsConnection.args.where.edge.current
CALL {
WITH this_drivecomposition
CALL {
WITH this_drivecomposition
MATCH (this_drivecomposition)-[this_drivecomposition_has_relationship:HAS]->(this_drivecomposition_Battery:Battery)
WHERE this_drivecomposition_has_relationship.current = $this_driveCompositionsConnection.edges.node.driveComponentConnection.args.where.Battery.edge.current
CALL apoc.util.validate(NOT((ANY(r IN ["admin"] WHERE ANY(rr IN $auth.roles WHERE r = rr)) AND apoc.util.validatePredicate(NOT($auth.isAuthenticated = true), "@neo4j/graphql/UNAUTHENTICATED", [0]))), "@neo4j/graphql/FORBIDDEN", [0])
WITH { current: this_drivecomposition_has_relationship.current, node: { __resolveType: "Battery", id: this_drivecomposition_Battery.id } } AS edge
RETURN edge
UNION
WITH this_drivecomposition
MATCH (this_drivecomposition)-[this_drivecomposition_has_relationship:HAS]->(this_drivecomposition_CombustionEngine:CombustionEngine)
WHERE this_drivecomposition_has_relationship.current = $this_driveCompositionsConnection.edges.node.driveComponentConnection.args.where.CombustionEngine.edge.current
WITH { current: this_drivecomposition_has_relationship.current, node: { __resolveType: "CombustionEngine", id: this_drivecomposition_CombustionEngine.id } } AS edge
RETURN edge
}
WITH collect(edge) as edges
RETURN { edges: edges, totalCount: size(edges) } AS driveComponentConnection
}
WITH collect({ node: { driveComponentConnection: driveComponentConnection } }) AS edges
RETURN { edges: edges, totalCount: size(edges) } AS driveCompositionsConnection
}
RETURN this { .current, driveCompositionsConnection } as this
----

'''

