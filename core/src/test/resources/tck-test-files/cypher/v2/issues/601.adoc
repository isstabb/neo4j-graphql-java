:toc:

= #601

== Source schema

[source,graphql,schema=true]
----
interface UploadedDocument @relationshipProperties {
  fileId: ID!
  uploadedAt: DateTime!
}

type Document @exclude(operations: [CREATE, UPDATE, DELETE]) {
  id: ID! @id
  stakeholder: Stakeholder! @relationship(type: "REQUIRES", direction: OUT)
  customerContact: CustomerContact! @relationship(type: "UPLOADED", properties: "UploadedDocument", direction: IN)
}

extend type Document @auth(rules: [{roles: ["view"]}])

type CustomerContact @exclude(operations: [CREATE, UPDATE, DELETE]) {
  email: String!
  firstname: String!
  lastname: String!
  documents: [Document!]! @relationship(type: "UPLOADED", properties: "UploadedDocument", direction: OUT)
}

extend type CustomerContact @auth(rules: [{roles: ["view"]}])

type Stakeholder @exclude(operations: [CREATE, UPDATE, DELETE]) {
  id: ID!
  fields: String!
  documents: [Document!]! @relationship(type: "REQUIRES", direction: OUT)
}

extend type Stakeholder @auth(rules: [{roles: ["view"]}])
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Example 1

.GraphQL-Query
[source,graphql]
----
query Document {
  stakeholders {
    documents {
      customerContactConnection {
        edges {
          fileId
          uploadedAt
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": false,
    "roles": []
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Stakeholder)
CALL apoc.util.validate(NOT(ANY(r IN ["view"] WHERE ANY(rr IN $auth.roles WHERE r = rr))), "@neo4j/graphql/FORBIDDEN", [0])
RETURN this { documents: [ (this)-[:REQUIRES]->(this_documents:Document)  WHERE apoc.util.validatePredicate(NOT(ANY(r IN ["view"] WHERE ANY(rr IN $auth.roles WHERE r = rr))), "@neo4j/graphql/FORBIDDEN", [0]) | this_documents { customerContactConnection: apoc.cypher.runFirstColumn("CALL {
WITH this_documents
MATCH (this_documents)<-[this_documents_uploaded_relationship:UPLOADED]-(this_documents_customercontact:CustomerContact)
CALL apoc.util.validate(NOT(ANY(r IN [\"view\"] WHERE ANY(rr IN $auth.roles WHERE r = rr))), \"@neo4j/graphql/FORBIDDEN\", [0])
WITH collect({ fileId: this_documents_uploaded_relationship.fileId, uploadedAt: apoc.date.convertFormat(toString(this_documents_uploaded_relationship.uploadedAt), \"iso_zoned_date_time\", \"iso_offset_date_time\") }) AS edges
RETURN { edges: edges, totalCount: size(edges) } AS customerContactConnection
} RETURN customerContactConnection", { this_documents: this_documents, auth: $auth }, false) } ] } as this
----

'''

