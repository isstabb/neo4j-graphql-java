:toc:

= https://github.com/neo4j/graphql/issues/1139

== Source schema

[source,graphql,schema=true]
----
union PostMovieUser = Post | Movie | User

type Post {
  name: String
}

type Movie {
  name: String
}

type User {
  id: ID @id
  updates: [PostMovieUser!]! @cypher(statement: """
  MATCH (this)-[a:WROTE]->(wrote:Post)
  WHERE a.date_added IS NOT NULL
  WITH COLLECT(wrote{ .*, date_added: a.date_added, typename: 'WROTE' }) as updates1, this
  MATCH (this)-[a:FOLLOWS]->(umb)
  WHERE (umb:User or umb:Movie or umb:Blog) AND a.date_added IS NOT NULL
  WITH updates1 + COLLECT(umb{ .*, date_added: a.date_added, typename: 'FOLLOWED' }) as allUpdates
  UNWIND allUpdates as update
  RETURN update
  ORDER BY update.date_added DESC
  LIMIT 5
  """)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== Querying the __typename on a relationship with a union array type in cypher statement

.GraphQL-Query
[source,graphql]
----
{
  users(where: {id: "test-id"}) {
    updates {
      __typename
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": "test-id",
  "auth": {
    "isAuthenticated": false,
    "roles": []
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:`User`)
WHERE this.id = $param0

CALL {
    WITH this
    UNWIND apoc.cypher.runFirstColumnMany("MATCH (this)-[a:WROTE]->(wrote:Post)
    WHERE a.date_added IS NOT NULL
    WITH COLLECT(wrote{ .*, date_added: a.date_added, typename: 'WROTE' }) as updates1, this
    MATCH (this)-[a:FOLLOWS]->(umb)
    WHERE (umb:User or umb:Movie or umb:Blog) AND a.date_added IS NOT NULL
    WITH updates1 + COLLECT(umb{ .*, date_added: a.date_added, typename: 'FOLLOWED' }) as allUpdates
    UNWIND allUpdates as update
    RETURN update
    ORDER BY update.date_added DESC
    LIMIT 5", { this: this, auth: $auth }) AS this_updates
    WITH *
    WHERE (this_updates:`Post` OR this_updates:`Movie` OR this_updates:`User`)
    RETURN collect(CASE
        WHEN this_updates:`Post` THEN this_updates { __resolveType: "Post" }
        WHEN this_updates:`Movie` THEN this_updates { __resolveType: "Movie" }
        WHEN this_updates:`User` THEN this_updates { __resolveType: "User" }
    END) AS this_updates
}
RETURN this { updates: this_updates } AS this
----

'''

