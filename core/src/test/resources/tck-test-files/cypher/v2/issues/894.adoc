:toc:

= https://github.com/neo4j/graphql/issues/894

== Source schema

[source,graphql,schema=true]
----
type User {
  id: ID! @id @alias(property: "_id")
  name: String!
  activeOrganization: Organization @relationship(type: "ACTIVELY_MANAGING", direction: OUT)
}

type Organization {
  id: ID! @id @alias(property: "_id")
  name: String!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Disconnect and connect

.GraphQL-Query
[source,graphql]
----
mutation SwapSides {
  updateUsers(
    where: {name: "Luke Skywalker"}
    connect: {activeOrganization: {where: {node: {id: "test-id"}}}}
    disconnect: {activeOrganization: {where: {node: {id_NOT: "test-id"}}}}
  ) {
    users {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_name": "Luke Skywalker",
  "this_connect_activeOrganization0_node_id": "test-id",
  "updateUsers": {
    "args": {
      "disconnect": {
        "activeOrganization": {
          "where": {
            "node": {
              "id_NOT": "test-id"
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
WHERE this.name = $this_name
WITH this
CALL {
	WITH this
	OPTIONAL MATCH (this_connect_activeOrganization0_node:Organization)
	WHERE this_connect_activeOrganization0_node._id = $this_connect_activeOrganization0_node_id
	FOREACH(_ IN CASE this WHEN NULL THEN [] ELSE [1] END | 
		FOREACH(_ IN CASE this_connect_activeOrganization0_node WHEN NULL THEN [] ELSE [1] END | 
			MERGE (this)-[:ACTIVELY_MANAGING]->(this_connect_activeOrganization0_node)
		)
	)
	RETURN count(*)
}
WITH this
CALL {
WITH this
OPTIONAL MATCH (this)-[this_disconnect_activeOrganization0_rel:ACTIVELY_MANAGING]->(this_disconnect_activeOrganization0:Organization)
WHERE (NOT this_disconnect_activeOrganization0._id = $updateUsers.args.disconnect.activeOrganization.where.node.id_NOT)
FOREACH(_ IN CASE this_disconnect_activeOrganization0 WHEN NULL THEN [] ELSE [1] END | 
DELETE this_disconnect_activeOrganization0_rel
)
RETURN count(*)
}
RETURN this { id: this._id } AS this
----

'''

