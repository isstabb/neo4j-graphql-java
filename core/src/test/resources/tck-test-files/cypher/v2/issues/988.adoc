:toc:

= https://github.com/neo4j/graphql/issues/988

== Source schema

[source,graphql,schema=true]
----
type Series {
  name: String
  current: Boolean!
  manufacturer: [Manufacturer!]! @relationship(type: "MANUFACTURER", properties: "RelationProps", direction: OUT)
  brand: [Brand!]! @relationship(type: "BRAND", properties: "RelationProps", direction: OUT)
}

type Brand {
  name: String
  current: Boolean!
}

type Manufacturer {
  name: String
  current: Boolean!
}

interface RelationProps {
  current: Boolean!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== where with multiple filters and params

.GraphQL-Query
[source,graphql]
----
query getSeriesWithRelationFilters($where: SeriesWhere = {current: true}) {
  series(where: $where) {
    name
    current
    manufacturerConnection {
      edges {
        current
        node {
          name
        }
      }
    }
    brandConnection {
      edges {
        current
        node {
          name
        }
      }
    }
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "current": true,
    "AND": [
      {
        "OR": [
          {
            "manufacturerConnection": {
              "edge": {
                "current": true
              },
              "node": {
                "name": "C"
              }
            }
          },
          {
            "manufacturerConnection": {
              "edge": {
                "current": false
              },
              "node": {
                "name": "AM"
              }
            }
          }
        ]
      },
      {
        "OR": [
          {
            "brandConnection": {
              "edge": {
                "current": true
              },
              "node": {
                "name": "smart"
              }
            }
          }
        ]
      }
    ]
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_AND_OR_series": {
    "where": {
      "manufacturerConnection": {
        "edge": {
          "current": true
        },
        "node": {
          "name": "C"
        }
      }
    }
  },
  "this_AND_OR1_series": {
    "where": {
      "manufacturerConnection": {
        "edge": {
          "current": false
        },
        "node": {
          "name": "AM"
        }
      }
    }
  },
  "this_AND1_OR_series": {
    "where": {
      "brandConnection": {
        "edge": {
          "current": true
        },
        "node": {
          "name": "smart"
        }
      }
    }
  },
  "this_current": true
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Series)
WHERE ((EXISTS((this)-[:MANUFACTURER]->(:Manufacturer)) AND ANY(this_AND_OR_manufacturerConnection_Manufacturer_map IN [(this)-[this_AND_OR_manufacturerConnection_Manufacturer_SeriesManufacturerRelationship:MANUFACTURER]->(this_AND_OR_manufacturerConnection_Manufacturer:Manufacturer)  | { node: this_AND_OR_manufacturerConnection_Manufacturer, relationship: this_AND_OR_manufacturerConnection_Manufacturer_SeriesManufacturerRelationship } ] WHERE this_AND_OR_manufacturerConnection_Manufacturer_map.relationship.current = $this_AND_OR_series.where.manufacturerConnection.edge.current AND this_AND_OR_manufacturerConnection_Manufacturer_map.node.name = $this_AND_OR_series.where.manufacturerConnection.node.name) OR EXISTS((this)-[:MANUFACTURER]->(:Manufacturer)) AND ANY(this_AND_OR1_manufacturerConnection_Manufacturer_map IN [(this)-[this_AND_OR1_manufacturerConnection_Manufacturer_SeriesManufacturerRelationship:MANUFACTURER]->(this_AND_OR1_manufacturerConnection_Manufacturer:Manufacturer)  | { node: this_AND_OR1_manufacturerConnection_Manufacturer, relationship: this_AND_OR1_manufacturerConnection_Manufacturer_SeriesManufacturerRelationship } ] WHERE this_AND_OR1_manufacturerConnection_Manufacturer_map.relationship.current = $this_AND_OR1_series.where.manufacturerConnection.edge.current AND this_AND_OR1_manufacturerConnection_Manufacturer_map.node.name = $this_AND_OR1_series.where.manufacturerConnection.node.name)) AND (EXISTS((this)-[:BRAND]->(:Brand)) AND ANY(this_AND1_OR_brandConnection_Brand_map IN [(this)-[this_AND1_OR_brandConnection_Brand_SeriesBrandRelationship:BRAND]->(this_AND1_OR_brandConnection_Brand:Brand)  | { node: this_AND1_OR_brandConnection_Brand, relationship: this_AND1_OR_brandConnection_Brand_SeriesBrandRelationship } ] WHERE this_AND1_OR_brandConnection_Brand_map.relationship.current = $this_AND1_OR_series.where.brandConnection.edge.current AND this_AND1_OR_brandConnection_Brand_map.node.name = $this_AND1_OR_series.where.brandConnection.node.name))) AND this.current = $this_current
CALL {
WITH this
MATCH (this)-[this_manufacturer_relationship:MANUFACTURER]->(this_manufacturer:Manufacturer)
WITH collect({ current: this_manufacturer_relationship.current, node: { name: this_manufacturer.name } }) AS edges
RETURN { edges: edges, totalCount: size(edges) } AS manufacturerConnection
}
CALL {
WITH this
MATCH (this)-[this_brand_relationship:BRAND]->(this_brand:Brand)
WITH collect({ current: this_brand_relationship.current, node: { name: this_brand.name } }) AS edges
RETURN { edges: edges, totalCount: size(edges) } AS brandConnection
}
RETURN this { .name, .current, manufacturerConnection, brandConnection } as this
----

'''

