:toc:

= https://github.com/neo4j/graphql/issues/1566

== Source schema

[source,graphql,schema=true]
----
type Content {
  id: Int!
  name: String!
}

type Project {
  id: Int!
  name: String!
}

union FeedItem = Content | Project

type Community {
  id: Int!
  name: String!
  hasFeedItems(limit: Int = 10, page: Int = 0): [FeedItem!]! @cypher(statement: """
  Match(this)-[:COMMUNITY_CONTENTPIECE_HASCONTENTPIECES|:COMMUNITY_PROJECT_HASASSOCIATEDPROJECTS]-(pag)
     return pag SKIP ($limit * $pageIndex) LIMIT $limit
  """)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== expectMultipleValues should be set to true in apoc.cypher.runFirstColumn

.GraphQL-Query
[source,graphql]
----
{
  communities(where: {id: 4656564}) {
    id
    hasFeedItems {
      __typename
      ... on Content {
        name
      }
      ... on Project {
        name
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": 4656564,
  "param1": 10,
  "param2": 0,
  "auth": {
    "isAuthenticated": false,
    "roles": []
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Community)
WHERE this.id = $param0
CALL {
	WITH this
	UNWIND apoc.cypher.runFirstColumnMany('Match(this)-[:COMMUNITY_CONTENTPIECE_HASCONTENTPIECES|:COMMUNITY_PROJECT_HASASSOCIATEDPROJECTS]-(pag)
       return pag SKIP ($limit * $pageIndex) LIMIT $limit', {
		limit: $param1,
		page: $param2,
		this: this,
		auth: $auth
	}) AS this_hasFeedItems
	WITH *
	WHERE (this_hasFeedItems:Content
		OR this_hasFeedItems:Project)
	RETURN collect(CASE WHEN this_hasFeedItems:Content THEN this_hasFeedItems {
		__resolveType: 'Content',
		.name
	} WHEN this_hasFeedItems:Project THEN this_hasFeedItems {
		__resolveType: 'Project',
		.name
	} END) AS this_hasFeedItems
}
RETURN this {
	.id,
	hasFeedItems: this_hasFeedItems
} AS this
----

'''

