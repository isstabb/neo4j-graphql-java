:toc:

= https://github.com/neo4j/graphql/issues/1364

== Source schema

[source,graphql,schema=true]
----
type Actor {
  id: ID
  name: String
  movies: [Movie!]! @relationship(type: "ACTED_IN", direction: OUT)
}

type Movie {
  id: ID
  title: String
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN)
  genres: [Genre!]! @relationship(type: "HAS_GENRE", direction: OUT)
  totalGenres: Int! @cypher(statement: """
  MATCH (this)-[:HAS_GENRE]->(genre:Genre)
  RETURN count(DISTINCT genre)
  """)
  totalActors: Int! @cypher(statement: """
  MATCH (this)<-[:ACTED_IN]-(actor:Actor)
  RETURN count(DISTINCT actor)
  """)
}

type Genre {
  id: ID
  name: String
  totalMovies: Int! @cypher(statement: """
  MATCH (this)<-[:HAS_GENRE]-(movie:Movie)
  RETURN count(DISTINCT movie)
  """)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Should project cypher fields after applying the sort when sorting on a non-cypher field on a root connection)

.GraphQL-Query
[source,graphql]
----
{
  moviesConnection(sort: [{title: ASC}]) {
    edges {
      node {
        title
        totalGenres
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH collect(this) AS edges
WITH edges, size(edges) AS totalCount
UNWIND edges AS this
WITH this, totalCount
WITH * ORDER BY this.title ASC
CALL {
	WITH this
	UNWIND apoc.cypher.runFirstColumnSingle('MATCH (this)-[:HAS_GENRE]->(genre:Genre)
    RETURN count(DISTINCT genre)', {
		this: this,
		auth: $auth
	}) AS this_totalGenres
	RETURN head(collect(this_totalGenres)) AS this_totalGenres
}
WITH {
	node: this {
		.title,
		totalGenres: this_totalGenres
	}
} AS edge, totalCount, this
WITH collect(edge) AS edges, totalCount
RETURN {
	edges: edges,
	totalCount: totalCount
} AS this
----

'''

== Should project cypher fields before the sort when sorting on a cypher field on a root connection

.GraphQL-Query
[source,graphql]
----
{
  moviesConnection(sort: [{totalGenres: ASC}]) {
    edges {
      node {
        title
        totalGenres
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH collect(this) AS edges
WITH edges, size(edges) AS totalCount
UNWIND edges AS this
WITH this, totalCount
CALL {
	WITH this
	UNWIND apoc.cypher.runFirstColumnSingle('MATCH (this)-[:HAS_GENRE]->(genre:Genre)
    RETURN count(DISTINCT genre)', {
		this: this,
		auth: $auth
	}) AS this_totalGenres
	RETURN head(collect(this_totalGenres)) AS this_totalGenres
}
WITH * ORDER BY this_totalGenres ASC
WITH {
	node: this {
		.title,
		totalGenres: this_totalGenres
	}
} AS edge, totalCount, this
WITH collect(edge) AS edges, totalCount
RETURN {
	edges: edges,
	totalCount: totalCount
} AS this
----

'''

== Should sort properly on a root connection when multiple cypher fields are queried but only sorted on one

.GraphQL-Query
[source,graphql]
----
{
  moviesConnection(sort: [{totalGenres: ASC}]) {
    edges {
      node {
        title
        totalGenres
        totalActors
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "auth": {
    "isAuthenticated": true,
    "roles": [],
    "jwt": {
      "roles": []
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH collect(this) AS edges
WITH edges, size(edges) AS totalCount
UNWIND edges AS this
WITH this, totalCount
CALL {
	WITH this
	UNWIND apoc.cypher.runFirstColumnSingle('MATCH (this)-[:HAS_GENRE]->(genre:Genre)
    RETURN count(DISTINCT genre)', {
		this: this,
		auth: $auth
	}) AS this_totalGenres
	RETURN head(collect(this_totalGenres)) AS this_totalGenres
}
WITH * ORDER BY this_totalGenres ASC
CALL {
	WITH this
	UNWIND apoc.cypher.runFirstColumnSingle('MATCH (this)<-[:ACTED_IN]-(actor:Actor)
    RETURN count(DISTINCT actor)', {
		this: this,
		auth: $auth
	}) AS this_totalActors
	RETURN head(collect(this_totalActors)) AS this_totalActors
}
WITH {
	node: this {
		.title,
		totalGenres: this_totalGenres,
		totalActors: this_totalActors
	}
} AS edge, totalCount, this
WITH collect(edge) AS edges, totalCount
RETURN {
	edges: edges,
	totalCount: totalCount
} AS this
----

'''

