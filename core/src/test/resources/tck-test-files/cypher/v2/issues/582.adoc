:toc:

= #582

== Source schema

[source,graphql,schema=true]
----
type Entity {
  children: [Entity!]! @relationship(type: "EDGE", properties: "Edge", direction: OUT)
  parents: [Entity!]! @relationship(type: "EDGE", properties: "Edge", direction: IN)
  type: String!
}

interface Edge @relationshipProperties {
  type: String!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== should be able to nest connection where inputs

.GraphQL-Query
[source,graphql]
----
query ($where: EntityWhere) {
  entities(where: $where) {
    type
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "type": "Cat",
    "childrenConnection": {
      "node": {
        "type": "Dog",
        "parentsConnection": {
          "node": {
            "type": "Bird"
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_type": "Cat",
  "this_entities": {
    "where": {
      "childrenConnection": {
        "node": {
          "type": "Dog",
          "parentsConnection": {
            "node": {
              "type": "Bird"
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Entity)
WHERE this.type = $this_type AND EXISTS((this)-[:EDGE]->(:Entity)) AND ANY(this_childrenConnection_Entity_map IN [(this)-[this_childrenConnection_Entity_EntityChildrenRelationship:EDGE]->(this_childrenConnection_Entity:Entity)  | { node: this_childrenConnection_Entity, relationship: this_childrenConnection_Entity_EntityChildrenRelationship } ] WHERE this_childrenConnection_Entity_map.node.type = $this_entities.where.childrenConnection.node.type AND apoc.cypher.runFirstColumn("RETURN EXISTS((this_childrenConnection_Entity_map_node)<-[:EDGE]-(:Entity))
AND ANY(this_childrenConnection_Entity_map_node_Entity_map IN [(this_childrenConnection_Entity_map_node)<-[this_childrenConnection_Entity_map_node_Entity_EntityParentsRelationship:EDGE]-(this_childrenConnection_Entity_map_node_Entity:Entity) | { node: this_childrenConnection_Entity_map_node_Entity, relationship: this_childrenConnection_Entity_map_node_Entity_EntityParentsRelationship } ] WHERE 
this_childrenConnection_Entity_map_node_Entity_map.node.type = $this_entities.where.childrenConnection.node.parentsConnection.node.type
)", { this_childrenConnection_Entity_map_node: this_childrenConnection_Entity_map.node, this_entities: $this_entities }))
RETURN this { .type } as this
----

'''

== should be able to nest connection where inputs down more levels

.GraphQL-Query
[source,graphql]
----
query ($where: EntityWhere) {
  entities(where: $where) {
    type
  }
}
----

.GraphQL params input
[source,json,request=true]
----
{
  "where": {
    "type": "Cat",
    "childrenConnection": {
      "node": {
        "type": "Dog",
        "parentsConnection": {
          "node": {
            "type": "Bird",
            "childrenConnection": {
              "node": {
                "type": "Fish"
              }
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_type": "Cat",
  "this_entities": {
    "where": {
      "childrenConnection": {
        "node": {
          "type": "Dog",
          "parentsConnection": {
            "node": {
              "type": "Bird",
              "childrenConnection": {
                "node": {
                  "type": "Fish"
                }
              }
            }
          }
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Entity)
WHERE this.type = $this_type AND EXISTS((this)-[:EDGE]->(:Entity)) AND ANY(this_childrenConnection_Entity_map IN [(this)-[this_childrenConnection_Entity_EntityChildrenRelationship:EDGE]->(this_childrenConnection_Entity:Entity)  | { node: this_childrenConnection_Entity, relationship: this_childrenConnection_Entity_EntityChildrenRelationship } ] WHERE this_childrenConnection_Entity_map.node.type = $this_entities.where.childrenConnection.node.type AND apoc.cypher.runFirstColumn("RETURN EXISTS((this_childrenConnection_Entity_map_node)<-[:EDGE]-(:Entity))
AND ANY(this_childrenConnection_Entity_map_node_Entity_map IN [(this_childrenConnection_Entity_map_node)<-[this_childrenConnection_Entity_map_node_Entity_EntityParentsRelationship:EDGE]-(this_childrenConnection_Entity_map_node_Entity:Entity) | { node: this_childrenConnection_Entity_map_node_Entity, relationship: this_childrenConnection_Entity_map_node_Entity_EntityParentsRelationship } ] WHERE 
this_childrenConnection_Entity_map_node_Entity_map.node.type = $this_entities.where.childrenConnection.node.parentsConnection.node.type AND apoc.cypher.runFirstColumn(\"RETURN EXISTS((this_childrenConnection_Entity_map_node_Entity_map_node)-[:EDGE]->(:Entity))
AND ANY(this_childrenConnection_Entity_map_node_Entity_map_node_Entity_map IN [(this_childrenConnection_Entity_map_node_Entity_map_node)-[this_childrenConnection_Entity_map_node_Entity_map_node_Entity_EntityChildrenRelationship:EDGE]->(this_childrenConnection_Entity_map_node_Entity_map_node_Entity:Entity) | { node: this_childrenConnection_Entity_map_node_Entity_map_node_Entity, relationship: this_childrenConnection_Entity_map_node_Entity_map_node_Entity_EntityChildrenRelationship } ] WHERE 
this_childrenConnection_Entity_map_node_Entity_map_node_Entity_map.node.type = $this_entities.where.childrenConnection.node.parentsConnection.node.childrenConnection.node.type
)\", { this_childrenConnection_Entity_map_node_Entity_map_node: this_childrenConnection_Entity_map_node_Entity_map.node, this_entities: $this_entities })
)", { this_childrenConnection_Entity_map_node: this_childrenConnection_Entity_map.node, this_entities: $this_entities }))
RETURN this { .type } as this
----

'''

