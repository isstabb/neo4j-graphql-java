:toc:

= Cypher directive

== Source schema

[source,graphql,schema=true]
----
type Actor {
  name: String
  year: Int
  movies(title: String): [Movie] @cypher(statement: """
  MATCH (m:Movie {title: $title})
  RETURN m
  """)
  tvShows(title: String): [Movie] @cypher(statement: """
  MATCH (t:TVShow {title: $title})
  RETURN t
  """)
  movieOrTVShow(title: String): [MovieOrTVShow] @cypher(statement: """
  MATCH (n)
  WHERE (n:TVShow OR n:Movie) AND ($title IS NULL OR n.title = $title)
  RETURN n
  """)
  randomNumber: Int @cypher(statement: """RETURN rand()""")
}

union MovieOrTVShow = Movie | TVShow

type TVShow {
  id: ID
  title: String
  numSeasons: Int
  actors: [Actor] @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """)
  topActor: Actor @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """)
}

type Movie {
  id: ID
  title: String
  actors: [Actor] @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """)
  topActor: Actor @cypher(statement: """
  MATCH (a:Actor)
  RETURN a
  """)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== LIMIT happens after custom Cypher if sorting on the custom Cypher field

.GraphQL-Query
[source,graphql]
----
{
  actors(options: {limit: 10, sort: [{randomNumber: ASC}]}) {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		RETURN rand() AS this_randomNumber
	}
	RETURN head(collect(this_randomNumber)) AS this_randomNumber
}
WITH * ORDER BY this_randomNumber ASC LIMIT $param0
RETURN this {
	randomNumber: this_randomNumber
} AS this
----

'''

== LIMIT happens before custom Cypher if not sorting on the custom Cypher field

.GraphQL-Query
[source,graphql]
----
{
  actors(options: {limit: 10}) {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : 10
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH * LIMIT $param0
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		RETURN rand() AS this_randomNumber
	}
	RETURN head(collect(this_randomNumber)) AS this_randomNumber
}
RETURN this {
	randomNumber: this_randomNumber
} AS this
----

'''

== Nested directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		MATCH (a:Actor)
		RETURN a AS this_topActor
	}
	CALL {
		WITH this_topActor
		CALL {
			WITH this_topActor
			WITH $param0 AS title, this_topActor AS this
			MATCH (m:Movie {
				title: title
			})
			RETURN m AS this_topActor_movies
		}
		RETURN collect(this_topActor_movies {
			.title
		}) AS this_topActor_movies
	}
	RETURN head(collect(this_topActor {
		.name,
		movies: this_topActor_movies
	})) AS this_topActor
}
RETURN this {
	.title,
	topActor: this_topActor
} AS this
----

'''

== Nested directive with params

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		MATCH (a:Actor)
		RETURN a AS this_topActor
	}
	CALL {
		WITH this_topActor
		CALL {
			WITH this_topActor
			WITH $param0 AS title, this_topActor AS this
			MATCH (m:Movie {
				title: title
			})
			RETURN m AS this_topActor_movies
		}
		RETURN collect(this_topActor_movies {
			.title
		}) AS this_topActor_movies
	}
	RETURN head(collect(this_topActor {
		.name,
		movies: this_topActor_movies
	})) AS this_topActor
}
RETURN this {
	.title,
	topActor: this_topActor
} AS this
----

'''

== Simple directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		MATCH (a:Actor)
		RETURN a AS this_topActor
	}
	RETURN head(collect(this_topActor {
		.name
	})) AS this_topActor
}
RETURN this {
	.title,
	topActor: this_topActor
} AS this
----

'''

== Simple directive (primitive)

.GraphQL-Query
[source,graphql]
----
{
  actors {
    randomNumber
  }
}
----

.Expected Cypher params
[source,json]
----
{ }
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		RETURN rand() AS this_randomNumber
	}
	RETURN head(collect(this_randomNumber)) AS this_randomNumber
}
RETURN this {
	randomNumber: this_randomNumber
} AS this
----

'''

== Super Nested directive

.GraphQL-Query
[source,graphql]
----
{
  movies {
    title
    topActor {
      name
      movies(title: "some title") {
        title
        topActor {
          name
          movies(title: "another title") {
            title
          }
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some title",
  "param1" : "another title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
	WITH this
	CALL {
		WITH this
		WITH this AS this
		MATCH (a:Actor)
		RETURN a AS this_topActor
	}
	CALL {
		WITH this_topActor
		CALL {
			WITH this_topActor
			WITH $param0 AS title, this_topActor AS this
			MATCH (m:Movie {
				title: title
			})
			RETURN m AS this_topActor_movies
		}
		CALL {
			WITH this_topActor_movies
			CALL {
				WITH this_topActor_movies
				WITH this_topActor_movies AS this
				MATCH (a:Actor)
				RETURN a AS this_topActor_movies_topActor
			}
			CALL {
				WITH this_topActor_movies_topActor
				CALL {
					WITH this_topActor_movies_topActor
					WITH $param1 AS title, this_topActor_movies_topActor AS this
					MATCH (m:Movie {
						title: title
					})
					RETURN m AS this_topActor_movies_topActor_movies
				}
				RETURN collect(this_topActor_movies_topActor_movies {
					.title
				}) AS this_topActor_movies_topActor_movies
			}
			RETURN head(collect(this_topActor_movies_topActor {
				.name,
				movies: this_topActor_movies_topActor_movies
			})) AS this_topActor_movies_topActor
		}
		RETURN collect(this_topActor_movies {
			.title,
			topActor: this_topActor_movies_topActor
		}) AS this_topActor_movies
	}
	RETURN head(collect(this_topActor {
		.name,
		movies: this_topActor_movies
	})) AS this_topActor
}
RETURN this {
	.title,
	topActor: this_topActor
} AS this
----

'''

== Union directive

.GraphQL-Query
[source,graphql]
----
{
  actors {
    movieOrTVShow(title: "some title") {
      ... on Movie {
        id
        title
        topActor {
          name
          year
        }
        actors {
          name
        }
      }
      ... on TVShow {
        id
        title
        topActor {
          name
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
	WITH this
	CALL {
		WITH this
		WITH $param0 AS title, this AS this
		MATCH (n)
		WHERE ((n:TVShow
				OR n:Movie)
			AND (title IS NULL
				OR n.title = title))
		RETURN n AS this_movieOrTVShow
	}
	WITH *
	WHERE (this_movieOrTVShow:Movie
		OR this_movieOrTVShow:TVShow)
	WITH *, this_movieOrTVShow AS this_movieOrTVShow_0
	CALL {
		WITH this_movieOrTVShow_0
		CALL {
			WITH this_movieOrTVShow_0
			WITH this_movieOrTVShow_0 AS this
			MATCH (a:Actor)
			RETURN a AS this_movieOrTVShow_0_topActor
		}
		RETURN head(collect(this_movieOrTVShow_0_topActor {
			.name,
			.year
		})) AS this_movieOrTVShow_0_topActor
	}
	CALL {
		WITH this_movieOrTVShow_0
		CALL {
			WITH this_movieOrTVShow_0
			WITH this_movieOrTVShow_0 AS this
			MATCH (a:Actor)
			RETURN a AS this_movieOrTVShow_0_actors
		}
		RETURN collect(this_movieOrTVShow_0_actors {
			.name
		}) AS this_movieOrTVShow_0_actors
	}
	WITH *, this_movieOrTVShow AS this_movieOrTVShow_1
	CALL {
		WITH this_movieOrTVShow_1
		CALL {
			WITH this_movieOrTVShow_1
			WITH this_movieOrTVShow_1 AS this
			MATCH (a:Actor)
			RETURN a AS this_movieOrTVShow_1_topActor
		}
		RETURN head(collect(this_movieOrTVShow_1_topActor {
			.name
		})) AS this_movieOrTVShow_1_topActor
	}
	RETURN collect(CASE WHEN this_movieOrTVShow:Movie THEN this_movieOrTVShow {
		__resolveType: 'Movie',
		.id,
		.title,
		topActor: this_movieOrTVShow_0_topActor,
		actors: this_movieOrTVShow_0_actors
	} WHEN this_movieOrTVShow:TVShow THEN this_movieOrTVShow {
		__resolveType: 'TVShow',
		.id,
		.title,
		topActor: this_movieOrTVShow_1_topActor
	} END) AS this_movieOrTVShow
}
RETURN this {
	movieOrTVShow: this_movieOrTVShow
} AS this
----

'''

== Union directive - querying only __typename

.GraphQL-Query
[source,graphql]
----
{
  actors {
    movieOrTVShow(title: "some title") {
      __typename
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0" : "some title"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
CALL {
	WITH this
	CALL {
		WITH this
		WITH $param0 AS title, this AS this
		MATCH (n)
		WHERE ((n:TVShow
				OR n:Movie)
			AND (title IS NULL
				OR n.title = title))
		RETURN n AS this_movieOrTVShow
	}
	WITH *
	WHERE (this_movieOrTVShow:Movie
		OR this_movieOrTVShow:TVShow)
	RETURN collect(CASE WHEN this_movieOrTVShow:Movie THEN this_movieOrTVShow {
		__resolveType: 'Movie'
	} WHEN this_movieOrTVShow:TVShow THEN this_movieOrTVShow {
		__resolveType: 'TVShow'
	} END) AS this_movieOrTVShow
}
RETURN this {
	movieOrTVShow: this_movieOrTVShow
} AS this
----

'''

