:toc:

= Interface Relationships - Update update

== Source schema

[source,graphql,schema=true]
----
interface Production {
  title: String!
  actors: [Actor!]! @relationship(type: "ACTED_IN", direction: IN, properties: "ActedIn")
}

type Movie implements Production {
  title: String!
  runtime: Int!
  actors: [Actor!]!
}

type Series implements Production {
  title: String!
  episodes: Int!
  actors: [Actor!]!
}

interface ActedIn @relationshipProperties {
  screenTime: Int!
}

type Actor {
  name: String!
  actedIn: [Production!]! @relationship(type: "ACTED_IN", direction: OUT, properties: "ActedIn")
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Update update an interface relationship

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    update: {actedIn: {where: {node: {title: "Old Title"}}, update: {node: {title: "New Title"}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_update_actedIn0_where_Movieparam0": "Old Title",
  "this_update_actedIn0_title": "New Title",
  "auth": {
    "isAuthenticated": false,
    "roles": []
  },
  "updateActors_args_update_actedIn0_where_Seriesparam0": "Old Title",
  "updateActors": {
    "args": {
      "update": {
        "actedIn": [
          {
            "update": {
              "node": {
                "title": "New Title"
              }
            },
            "where": {
              "node": {
                "title": "Old Title"
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Movie)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Movieparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '


SET this_actedIn0.title = $this_update_actedIn0_title

RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth,
		this_update_actedIn0_title: $this_update_actedIn0_title
	}) YIELD value AS _
	RETURN count(*) AS update_this_Movie
}
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Series)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Seriesparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '


SET this_actedIn0.title = $this_update_actedIn0_title

RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth,
		this_update_actedIn0_title: $this_update_actedIn0_title
	}) YIELD value AS _
	RETURN count(*) AS update_this_Series
}
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update update an interface relationship with nested update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    update: {actedIn: {where: {node: {title: "Old Title"}}, update: {node: {actors: {update: {node: {name: "New Actor Name"}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_update_actedIn0_where_Movieparam0": "Old Title",
  "this_update_actedIn0_actors0_name": "New Actor Name",
  "auth": {
    "isAuthenticated": false,
    "roles": []
  },
  "updateActors_args_update_actedIn0_where_Seriesparam0": "Old Title",
  "updateActors": {
    "args": {
      "update": {
        "actedIn": [
          {
            "update": {
              "node": {
                "actors": [
                  {
                    "update": {
                      "node": {
                        "name": "New Actor Name"
                      }
                    }
                  }
                ]
              }
            },
            "where": {
              "node": {
                "title": "Old Title"
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Movie)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Movieparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '


WITH this, this_actedIn0
OPTIONAL MATCH (this_actedIn0)<-[this_actedIn0_acted_in0_relationship:ACTED_IN]-(this_actedIn0_actors0:Actor)
CALL apoc.do.when(this_actedIn0_actors0 IS NOT NULL, \"


SET this_actedIn0_actors0.name = $this_update_actedIn0_actors0_name

RETURN count(*) AS _
\", \"\", {this:this, this_actedIn0:this_actedIn0, updateActors: $updateActors, this_actedIn0_actors0:this_actedIn0_actors0, auth:$auth,this_update_actedIn0_actors0_name:$this_update_actedIn0_actors0_name})
YIELD value AS _

RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth,
		this_update_actedIn0_actors0_name: $this_update_actedIn0_actors0_name
	}) YIELD value AS _
	RETURN count(*) AS update_this_Movie
}
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Series)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Seriesparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '


WITH this, this_actedIn0
OPTIONAL MATCH (this_actedIn0)<-[this_actedIn0_acted_in0_relationship:ACTED_IN]-(this_actedIn0_actors0:Actor)
CALL apoc.do.when(this_actedIn0_actors0 IS NOT NULL, \"


SET this_actedIn0_actors0.name = $this_update_actedIn0_actors0_name

RETURN count(*) AS _
\", \"\", {this:this, this_actedIn0:this_actedIn0, updateActors: $updateActors, this_actedIn0_actors0:this_actedIn0_actors0, auth:$auth,this_update_actedIn0_actors0_name:$this_update_actedIn0_actors0_name})
YIELD value AS _

RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth,
		this_update_actedIn0_actors0_name: $this_update_actedIn0_actors0_name
	}) YIELD value AS _
	RETURN count(*) AS update_this_Series
}
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update update an interface relationship with nested update using _on to only update one implementation

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    update: {actedIn: {where: {node: {title: "Old Title"}}, update: {node: {_on: {Movie: {actors: {update: {node: {name: "New Actor Name"}}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_update_actedIn0_where_Movieparam0": "Old Title",
  "auth": {
    "isAuthenticated": false,
    "roles": []
  },
  "this_update_actedIn0_on_Movie_actors0_name": "New Actor Name",
  "updateActors_args_update_actedIn0_where_Seriesparam0": "Old Title",
  "updateActors": {
    "args": {
      "update": {
        "actedIn": [
          {
            "update": {
              "node": {
                "_on": {
                  "Movie": {
                    "actors": [
                      {
                        "update": {
                          "node": {
                            "name": "New Actor Name"
                          }
                        }
                      }
                    ]
                  }
                }
              }
            },
            "where": {
              "node": {
                "title": "Old Title"
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Movie)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Movieparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '





WITH this, this_actedIn0
OPTIONAL MATCH (this_actedIn0)<-[this_actedIn0_acted_in0_relationship:ACTED_IN]-(this_actedIn0_actors0:Actor)
CALL apoc.do.when(this_actedIn0_actors0 IS NOT NULL, \"


SET this_actedIn0_actors0.name = $this_update_actedIn0_on_Movie_actors0_name

RETURN count(*) AS _
\", \"\", {this:this, this_actedIn0:this_actedIn0, updateActors: $updateActors, this_actedIn0_actors0:this_actedIn0_actors0, auth:$auth,this_update_actedIn0_on_Movie_actors0_name:$this_update_actedIn0_on_Movie_actors0_name})
YIELD value AS _

RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth,
		this_update_actedIn0_on_Movie_actors0_name: $this_update_actedIn0_on_Movie_actors0_name
	}) YIELD value AS _
	RETURN count(*) AS update_this_Movie
}
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Series)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Seriesparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '



RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth
	}) YIELD value AS _
	RETURN count(*) AS update_this_Series
}
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

== Update update an interface relationship with nested update using _on to override update

.GraphQL-Query
[source,graphql]
----
mutation {
  updateActors(
    update: {actedIn: {where: {node: {title: "Old Title"}}, update: {node: {actors: {update: {node: {name: "New Actor Name"}}}, _on: {Movie: {actors: {update: {node: {name: "Different Actor Name"}}}}}}}}}
  ) {
    actors {
      name
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "updateActors_args_update_actedIn0_where_Movieparam0": "Old Title",
  "auth": {
    "isAuthenticated": false,
    "roles": []
  },
  "this_update_actedIn0_on_Movie_actors0_name": "Different Actor Name",
  "updateActors_args_update_actedIn0_where_Seriesparam0": "Old Title",
  "this_update_actedIn0_actors0_name": "New Actor Name",
  "updateActors": {
    "args": {
      "update": {
        "actedIn": [
          {
            "update": {
              "node": {
                "_on": {
                  "Movie": {
                    "actors": [
                      {
                        "update": {
                          "node": {
                            "name": "Different Actor Name"
                          }
                        }
                      }
                    ]
                  }
                },
                "actors": [
                  {
                    "update": {
                      "node": {
                        "name": "New Actor Name"
                      }
                    }
                  }
                ]
              }
            },
            "where": {
              "node": {
                "title": "Old Title"
              }
            }
          }
        ]
      }
    }
  },
  "resolvedCallbacks": {}
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Actor)
WITH this
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Movie)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Movieparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '





WITH this, this_actedIn0
OPTIONAL MATCH (this_actedIn0)<-[this_actedIn0_acted_in0_relationship:ACTED_IN]-(this_actedIn0_actors0:Actor)
CALL apoc.do.when(this_actedIn0_actors0 IS NOT NULL, \"


SET this_actedIn0_actors0.name = $this_update_actedIn0_on_Movie_actors0_name

RETURN count(*) AS _
\", \"\", {this:this, this_actedIn0:this_actedIn0, updateActors: $updateActors, this_actedIn0_actors0:this_actedIn0_actors0, auth:$auth,this_update_actedIn0_on_Movie_actors0_name:$this_update_actedIn0_on_Movie_actors0_name})
YIELD value AS _

RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth,
		this_update_actedIn0_on_Movie_actors0_name: $this_update_actedIn0_on_Movie_actors0_name
	}) YIELD value AS _
	RETURN count(*) AS update_this_Movie
}
CALL {
	WITH this
	WITH this
	OPTIONAL MATCH (this)-[this_acted_in0_relationship:ACTED_IN]->(this_actedIn0:Series)
	WHERE this_actedIn0.title = $updateActors_args_update_actedIn0_where_Seriesparam0
	CALL apoc.do.when(this_actedIn0 IS NOT NULL, '


WITH this, this_actedIn0
OPTIONAL MATCH (this_actedIn0)<-[this_actedIn0_acted_in0_relationship:ACTED_IN]-(this_actedIn0_actors0:Actor)
CALL apoc.do.when(this_actedIn0_actors0 IS NOT NULL, \"


SET this_actedIn0_actors0.name = $this_update_actedIn0_actors0_name

RETURN count(*) AS _
\", \"\", {this:this, this_actedIn0:this_actedIn0, updateActors: $updateActors, this_actedIn0_actors0:this_actedIn0_actors0, auth:$auth,this_update_actedIn0_actors0_name:$this_update_actedIn0_actors0_name})
YIELD value AS _

RETURN count(*) AS _
', '', {
		this: this,
		updateActors: $updateActors,
		this_actedIn0: this_actedIn0,
		auth: $auth,
		this_update_actedIn0_actors0_name: $this_update_actedIn0_actors0_name
	}) YIELD value AS _
	RETURN count(*) AS update_this_Series
}
RETURN collect(DISTINCT this {
	.name
}) AS data
----

'''

