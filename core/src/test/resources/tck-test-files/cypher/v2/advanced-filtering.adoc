:toc:

= Cypher Advanced Filtering

== Source schema

[source,graphql,schema=true]
----
type Movie {
  _id: ID
  id: ID
  title: String
  actorCount: Int
  budget: BigInt
  genres: [Genre!]! @relationship(type: "IN_GENRE", direction: OUT)
}

type Genre {
  name: String
  movies: [Movie!]! @relationship(type: "IN_GENRE", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== CONTAINS

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_CONTAINS: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdContains" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id CONTAINS $whereMoviesIdContains
RETURN movies {
	.id
} AS movies
----

'''

== ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_ENDS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdEndsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id ENDS WITH $whereMoviesIdEndsWith
RETURN movies {
	.id
} AS movies
----

'''

== GT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_GT: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountGt" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount > $whereMoviesActorCountGt
RETURN movies {
	.actorCount
} AS movies
----

'''

== GT BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_GT: 9223372036854775000}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesBudgetGt" : 9223372036854775000
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.budget > $whereMoviesBudgetGt
RETURN movies {
	.budget
} AS movies
----

'''

== GTE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_GTE: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountGte" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount >= $whereMoviesActorCountGte
RETURN movies {
	.actorCount
} AS movies
----

'''

== GTE BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_GTE: 9223372036854775000}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesBudgetGte" : 9223372036854775000
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.budget >= $whereMoviesBudgetGte
RETURN movies {
	.budget
} AS movies
----

'''

== IN

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {_id_IN: ["123"]}) {
    _id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMovies_idIn" : [ "123" ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies._id IN $whereMovies_idIn
RETURN movies {
	_id
} AS movies
----

'''

== LT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_LT: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountLt" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount < $whereMoviesActorCountLt
RETURN movies {
	.actorCount
} AS movies
----

'''

== LT BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_LT: 9223372036854775807}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesBudgetLt" : 9223372036854775807
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.budget < $whereMoviesBudgetLt
RETURN movies {
	.budget
} AS movies
----

'''

== LTE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_LTE: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesActorCountLte" : 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.actorCount <= $whereMoviesActorCountLte
RETURN movies {
	.actorCount
} AS movies
----

'''

== LTE BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_LTE: 9223372036854775807}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesBudgetLte" : 9223372036854775807
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.budget <= $whereMoviesBudgetLte
RETURN movies {
	.budget
} AS movies
----

'''

== Node and relationship properties equality

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesGenreName" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE any(whereMoviesGenreCond IN [(movies)-[whereMoviesGenreMovieGenresRelationship:IN_GENRE]->(whereMoviesGenre:Genre) | whereMoviesGenre.name = $whereMoviesGenreName]
WHERE whereMoviesGenreCond)
RETURN movies {
	.actorCount
} AS movies
----

'''

== Node and relationship properties NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_NOT: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesGenreName" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE none(whereMoviesGenreCond IN [(movies)-[whereMoviesGenreMovieGenresRelationship:IN_GENRE]->(whereMoviesGenre:Genre) | whereMoviesGenre.name = $whereMoviesGenreName]
WHERE whereMoviesGenreCond)
RETURN movies {
	.actorCount
} AS movies
----

'''

== NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNot" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id = $whereMoviesIdNot)
RETURN movies {
	.id
} AS movies
----

'''

== NOT_CONTAINS

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_CONTAINS: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotContains" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id CONTAINS $whereMoviesIdNotContains)
RETURN movies {
	.id
} AS movies
----

'''

== NOT_ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_ENDS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotEndsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id ENDS WITH $whereMoviesIdNotEndsWith)
RETURN movies {
	.id
} AS movies
----

'''

== NOT_IN

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_IN: ["123"]}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotIn" : [ "123" ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id IN $whereMoviesIdNotIn)
RETURN movies {
	.id
} AS movies
----

'''

== NOT_STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_STARTS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdNotStartsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE NOT (movies.id STARTS WITH $whereMoviesIdNotStartsWith)
RETURN movies {
	.id
} AS movies
----

'''

== REGEX

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_MATCHES: "(?i)123.*"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdMatches" : "(?i)123.*"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id =~ $whereMoviesIdMatches
RETURN movies {
	.id
} AS movies
----

'''

== Relationship equality

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesGenreName" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND ANY(this_genres IN [(this)-[:IN_GENRE]->(this_genres:Genre) | this_genres] WHERE this_genres.name = $this_genres_name)
RETURN this { .actorCount } as this
----

'''

== Relationship NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_NOT: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesGenreName" : "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE none(whereMoviesGenreCond IN [(movies)-[:IN_GENRE]->(whereMoviesGenre:Genre) | whereMoviesGenre.name = $whereMoviesGenreName]
WHERE whereMoviesGenreCond)
RETURN movies {
	.actorCount
} AS movies
----

'''

== STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_STARTS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "whereMoviesIdStartsWith" : "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (movies:Movie)
WHERE movies.id STARTS WITH $whereMoviesIdStartsWith
RETURN movies {
	.id
} AS movies
----

'''

