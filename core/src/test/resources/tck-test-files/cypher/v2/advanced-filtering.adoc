:toc:

= Cypher Advanced Filtering

== Source schema

[source,graphql,schema=true]
----
type Movie {
  _id: ID
  id: ID
  title: String
  actorCount: Int
  budget: BigInt
  genres: [Genre!]! @relationship(type: "IN_GENRE", direction: OUT)
}

type Genre {
  name: String
  movies: [Movie!]! @relationship(type: "IN_GENRE", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== CONTAINS

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_CONTAINS: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_CONTAINS": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id CONTAINS $this_id_CONTAINS
RETURN this { .id } as this
----

'''

== ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_ENDS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_ENDS_WITH": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id ENDS WITH $this_id_ENDS_WITH
RETURN this { .id } as this
----

'''

== GT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_GT: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorCount_GT": 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount > $this_actorCount_GT
RETURN this { .actorCount } as this
----

'''

== GT BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_GT: 9223372036854775000}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_budget_GT": "9223372036854775000"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget > $this_budget_GT
RETURN this { .budget } as this
----

'''

== GTE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_GTE: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorCount_GTE": 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount >= $this_actorCount_GTE
RETURN this { .actorCount } as this
----

'''

== GTE BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_GTE: 9223372036854775000}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_budget_GTE": "9223372036854775000"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget >= $this_budget_GTE
RETURN this { .budget } as this
----

'''

== IN

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {_id_IN: ["123"]}) {
    _id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this__id_IN": [
    "123"
  ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this._id IN $this__id_IN
RETURN this { ._id } as this
----

'''

== LT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_LT: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorCount_LT": 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount < $this_actorCount_LT
RETURN this { .actorCount } as this
----

'''

== LT BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_LT: 9223372036854775807}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_budget_LT": "9223372036854775807"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget < $this_budget_LT
RETURN this { .budget } as this
----

'''

== LTE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {actorCount_LTE: 123}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_actorCount_LTE": 123
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.actorCount <= $this_actorCount_LTE
RETURN this { .actorCount } as this
----

'''

== LTE BigInt

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {budget_LTE: 9223372036854775807}) {
    budget
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_budget_LTE": "9223372036854775807"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.budget <= $this_budget_LTE
RETURN this { .budget } as this
----

'''

== NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_NOT": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE (NOT this.id = $this_id_NOT)
RETURN this { .id } as this
----

'''

== NOT_CONTAINS

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_CONTAINS: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_NOT_CONTAINS": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE (NOT this.id CONTAINS $this_id_NOT_CONTAINS)
RETURN this { .id } as this
----

'''

== NOT_ENDS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_ENDS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_NOT_ENDS_WITH": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE (NOT this.id ENDS WITH $this_id_NOT_ENDS_WITH)
RETURN this { .id } as this
----

'''

== NOT_IN

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_IN: ["123"]}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_NOT_IN": [
    "123"
  ]
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE (NOT this.id IN $this_id_NOT_IN)
RETURN this { .id } as this
----

'''

== NOT_STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_NOT_STARTS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_NOT_STARTS_WITH": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE (NOT this.id STARTS WITH $this_id_NOT_STARTS_WITH)
RETURN this { .id } as this
----

'''

== REGEX

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_MATCHES: "(?i)123.*"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_MATCHES": "(?i)123.*"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id =~ $this_id_MATCHES
RETURN this { .id } as this
----

'''

== STARTS_WITH

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {id_STARTS_WITH: "123"}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_id_STARTS_WITH": "123"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE this.id STARTS WITH $this_id_STARTS_WITH
RETURN this { .id } as this
----

'''

== Connections

=== Node and relationship properties equality

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_movies": {
    "where": {
      "genresConnection": {
        "node": {
          "name": "some genre"
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND ANY(this_genresConnection_Genre_map IN [(this)-[this_genresConnection_Genre_MovieGenresRelationship:IN_GENRE]->(this_genresConnection_Genre:Genre)  | { node: this_genresConnection_Genre, relationship: this_genresConnection_Genre_MovieGenresRelationship } ] WHERE this_genresConnection_Genre_map.node.name = $this_movies.where.genresConnection.node.name)
RETURN this { .actorCount } as this
----

'''

=== Node and relationship properties NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_NOT: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_movies": {
    "where": {
      "genresConnection_NOT": {
        "node": {
          "name": "some genre"
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND NONE(this_genresConnection_NOT_Genre_map IN [(this)-[this_genresConnection_NOT_Genre_MovieGenresRelationship:IN_GENRE]->(this_genresConnection_NOT_Genre:Genre)  | { node: this_genresConnection_NOT_Genre, relationship: this_genresConnection_NOT_Genre_MovieGenresRelationship } ] WHERE this_genresConnection_NOT_Genre_map.node.name = $this_movies.where.genresConnection_NOT.node.name)
RETURN this { .actorCount } as this
----

'''

=== List Predicates

==== ALL

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_ALL: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_movies": {
    "where": {
      "genresConnection_ALL": {
        "node": {
          "name": "some genre"
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND ALL(this_genresConnection_ALL_Genre_map IN [(this)-[this_genresConnection_ALL_Genre_MovieGenresRelationship:IN_GENRE]->(this_genresConnection_ALL_Genre:Genre)  | { node: this_genresConnection_ALL_Genre, relationship: this_genresConnection_ALL_Genre_MovieGenresRelationship } ] WHERE this_genresConnection_ALL_Genre_map.node.name = $this_movies.where.genresConnection_ALL.node.name)
RETURN this { .actorCount } as this
----

'''

==== NONE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_NONE: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_movies": {
    "where": {
      "genresConnection_NONE": {
        "node": {
          "name": "some genre"
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND NONE(this_genresConnection_NONE_Genre_map IN [(this)-[this_genresConnection_NONE_Genre_MovieGenresRelationship:IN_GENRE]->(this_genresConnection_NONE_Genre:Genre)  | { node: this_genresConnection_NONE_Genre, relationship: this_genresConnection_NONE_Genre_MovieGenresRelationship } ] WHERE this_genresConnection_NONE_Genre_map.node.name = $this_movies.where.genresConnection_NONE.node.name)
RETURN this { .actorCount } as this
----

'''

==== SINGLE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SINGLE: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_movies": {
    "where": {
      "genresConnection_SINGLE": {
        "node": {
          "name": "some genre"
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND SINGLE(this_genresConnection_SINGLE_Genre_map IN [(this)-[this_genresConnection_SINGLE_Genre_MovieGenresRelationship:IN_GENRE]->(this_genresConnection_SINGLE_Genre:Genre)  | { node: this_genresConnection_SINGLE_Genre, relationship: this_genresConnection_SINGLE_Genre_MovieGenresRelationship } ] WHERE this_genresConnection_SINGLE_Genre_map.node.name = $this_movies.where.genresConnection_SINGLE.node.name)
RETURN this { .actorCount } as this
----

'''

==== SOME

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genresConnection_SOME: {node: {name: "some genre"}}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_movies": {
    "where": {
      "genresConnection_SOME": {
        "node": {
          "name": "some genre"
        }
      }
    }
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND ANY(this_genresConnection_SOME_Genre_map IN [(this)-[this_genresConnection_SOME_Genre_MovieGenresRelationship:IN_GENRE]->(this_genresConnection_SOME_Genre:Genre)  | { node: this_genresConnection_SOME_Genre, relationship: this_genresConnection_SOME_Genre_MovieGenresRelationship } ] WHERE this_genresConnection_SOME_Genre_map.node.name = $this_movies.where.genresConnection_SOME.node.name)
RETURN this { .actorCount } as this
----

'''



== Relationships

=== equality

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_genres_name": "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND ANY(this_genres IN [(this)-[:IN_GENRE]->(this_genres:Genre) | this_genres] WHERE this_genres.name = $this_genres_name)
RETURN this { .actorCount } as this
----

'''

=== NOT

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_NOT: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_genres_NOT_name": "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND NONE(this_genres_NOT IN [(this)-[:IN_GENRE]->(this_genres_NOT:Genre) | this_genres_NOT] WHERE this_genres_NOT.name = $this_genres_NOT_name)
RETURN this { .actorCount } as this
----

'''

=== List Predicates

==== ALL

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_ALL: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_genres_ALL_name": "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND ALL(this_genres_ALL IN [(this)-[:IN_GENRE]->(this_genres_ALL:Genre) | this_genres_ALL] WHERE this_genres_ALL.name = $this_genres_ALL_name)
RETURN this { .actorCount } as this
----

'''

==== NONE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_NONE: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_genres_NONE_name": "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND NONE(this_genres_NONE IN [(this)-[:IN_GENRE]->(this_genres_NONE:Genre) | this_genres_NONE] WHERE this_genres_NONE.name = $this_genres_NONE_name)
RETURN this { .actorCount } as this
----

'''

==== SINGLE

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_SINGLE: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_genres_SINGLE_name": "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND SINGLE(this_genres_SINGLE IN [(this)-[:IN_GENRE]->(this_genres_SINGLE:Genre) | this_genres_SINGLE] WHERE this_genres_SINGLE.name = $this_genres_SINGLE_name)
RETURN this { .actorCount } as this
----

'''

==== SOME

.GraphQL-Query
[source,graphql]
----
{
  movies(where: {genres_SOME: {name: "some genre"}}) {
    actorCount
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_genres_SOME_name": "some genre"
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WHERE EXISTS((this)-[:IN_GENRE]->(:Genre)) AND ANY(this_genres_SOME IN [(this)-[:IN_GENRE]->(this_genres_SOME:Genre) | this_genres_SOME] WHERE this_genres_SOME.name = $this_genres_SOME_name)
RETURN this { .actorCount } as this
----

'''



