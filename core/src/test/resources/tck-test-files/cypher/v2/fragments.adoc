:toc:

= Cypher Fragment

== Source schema

[source,graphql,schema=true]
----
interface Entity {
  username: String!
}

type User implements Entity {
  id: ID! @id
  username: String!
  owns: [OwnableType!]! @relationship(type: "OWNS", direction: OUT)
}

union OwnableType = Tile | Character

interface Ownable {
  id: ID!
  owner: User
}

type Tile implements Ownable {
  id: ID! @id
  owner: User! @relationship(type: "OWNS", direction: IN)
}

type Character implements Ownable {
  id: ID! @id
  owner: User! @relationship(type: "OWNS", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{
  "enableRegex": true
}
----
== Fragment On Interface

.GraphQL-Query
[source,graphql]
----
{
  users {
    id
    ...FragmentOnInterface
  }
}

fragment FragmentOnInterface on Entity {
  username
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
RETURN this {
	.id,
	.username
} AS this
----

'''

== Fragment On Type

.GraphQL-Query
[source,graphql]
----
{
  users {
    id
    ...FragmentOnType
  }
}

fragment FragmentOnType on User {
  username
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
RETURN this {
	.id,
	.username
} AS this
----

'''

== Fragment On Union

.GraphQL-Query
[source,graphql]
----
query users {
  users {
    id
    owns {
      __typename
      ... on Ownable {
        id
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:User)
CALL {
	WITH this
	CALL {
		WITH *
		MATCH (this)-[this0:OWNS]->(this_owns:Tile)
		WITH this_owns {
			__resolveType: 'Tile'
		} AS this_owns
		RETURN this_owns AS this_owns UNION
		WITH *
		MATCH (this)-[this1:OWNS]->(this_owns:Character)
		WITH this_owns {
			__resolveType: 'Character'
		} AS this_owns
		RETURN this_owns AS this_owns
	}
	WITH this_owns
	RETURN collect(this_owns) AS this_owns
}
RETURN this {
	.id,
	owns: this_owns
} AS this
----

'''

