:toc:

= Cypher -> fulltext -> Auth

== Source schema

[source,graphql,schema=true]
----
type Movie @fulltext(indexes: [{name: "MovieTitle", fields: ["title"]}]) @auth(rules: [{allow: {director: {id: "$jwt.sub"}}}]) {
  title: String
  director: [Person!]! @relationship(type: "DIRECTED", direction: IN)
}

type Person {
  id: ID
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== simple match with auth allow

.GraphQL-Query
[source,graphql]
----
{
  movies(fulltext: {MovieTitle: {phrase: "something AND something"}}) {
    title
  }
}
----

.Query Context
[source,json,query-config=true]
----
{
  "contextParams": {
    "jwt": {
      "sub": "random-uuid"
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_fulltext_MovieTitle_phrase": "something AND something",
  "this_auth_allow0_director_id": "random-uuid"
}
----

.Expected Cypher output
[source,cypher]
----
CALL db.index.fulltext.queryNodes(
    "MovieTitle",
    $this_fulltext_MovieTitle_phrase
) YIELD node as this, score as score
CALL apoc.util.validate(NOT(EXISTS((this)<-[:DIRECTED]-(:Person)) AND ANY(director IN [(this)<-[:DIRECTED]-(director:Person) | director] WHERE director.id IS NOT NULL AND director.id = $this_auth_allow0_director_id)), "@neo4j/graphql/FORBIDDEN", [0])
RETURN this { .title } as this
----

'''

