:toc:

= tck/rfcs/query-limits

== Source schema

[source,graphql,schema=true]
----
type Movie @queryOptions(limit: {default: 3, max: 5}) {
  id: ID!
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN)
}

type Person @queryOptions(limit: {default: 2}) {
  id: ID!
}

type Show @queryOptions(limit: {max: 2}) {
  id: ID!
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== Field Level Query Limits

=== should limit the connection field level query

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
    actorsConnection {
      edges {
        node {
          id
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_limit": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
CALL {
WITH this
MATCH (this)<-[this_acted_in_relationship:ACTED_IN]-(this_person:Person)
WITH collect({ node: { id: this_person.id } }) AS edges
WITH size(edges) AS totalCount, edges[..2] AS limitedSelection
RETURN { edges: limitedSelection, totalCount: totalCount } AS actorsConnection
}
RETURN this { .id, actorsConnection } as this
LIMIT $this_limit
----

'''

=== should limit the normal field level query

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
    actors {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_limit": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
RETURN this { .id, actors: [ (this)<-[:ACTED_IN]-(this_actors:Person)   | this_actors { .id } ][..2] } as this
LIMIT $this_limit
----

'''

=== should limit the relationship field level query

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
    actors {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_limit": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
RETURN this { .id, actors: [ (this)<-[:ACTED_IN]-(this_actors:Person)   | this_actors { .id } ][..2] } as this
LIMIT $this_limit
----

'''


== Top Level Query Limits

=== should limit the top level query with default value

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_limit": 3
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
RETURN this { .id } as this
LIMIT $this_limit
----

'''

=== should limit the top level query with max value if not default is available

.GraphQL-Query
[source,graphql]
----
{
  shows {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_limit": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Show)
RETURN this { .id } as this
LIMIT $this_limit
----

'''

=== should limit the top level query with max value the option given is higher

.GraphQL-Query
[source,graphql]
----
{
  shows(options: {limit: 5}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_limit": 2
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Show)
RETURN this { .id } as this
LIMIT $this_limit
----

'''


