:toc:

= tck/rfcs/query-limits

== Source schema

[source,graphql,schema=true]
----
type Movie @queryOptions(limit: {default: 3, max: 5}) {
  id: ID!
  actors: [Person!]! @relationship(type: "ACTED_IN", direction: IN)
}

type Person @queryOptions(limit: {default: 2}) {
  id: ID!
}

type Show @queryOptions(limit: {max: 2}) {
  id: ID!
}

type Festival {
  name: String!
  shows: [Show!]! @relationship(type: "PART_OF", direction: IN)
}
----

== Configuration

.Configuration
[source,json,schema-config=true]
----
{}
----
== Field Level Query Limits

=== should extend the limit to the connection field if `first` provided

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
    actorsConnection(first: 4) {
      edges {
        node {
          id
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": {
    "low": 3,
    "high": 0
  },
  "this_connection_actorsConnectionparam0": {
    "low": 4,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * LIMIT $param0
CALL {
	WITH this
	MATCH (this)<-[this_connection_actorsConnectionthis0:ACTED_IN]-(this_Person:Person)
	WITH {
		node: {
			id: this_Person.id
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	CALL {
		WITH edges
		UNWIND edges AS edge
		WITH edge LIMIT $this_connection_actorsConnectionparam0
		RETURN collect(edge) AS this_connection_actorsConnectionvar1
	}
	WITH this_connection_actorsConnectionvar1 AS edges, totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_actorsConnection
}
RETURN this {
	.id,
	actorsConnection: this_actorsConnection
} AS this
----

'''

=== should extend the limit to the connection field if `first` provided, honouring the `max` argument

.GraphQL-Query
[source,graphql]
----
{
  festivals {
    name
    showsConnection(first: 3) {
      edges {
        node {
          id
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "this_connection_showsConnectionparam0": {
    "low": 2,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Festival)
CALL {
	WITH this
	MATCH (this)<-[this_connection_showsConnectionthis0:PART_OF]-(this_Show:Show)
	WITH {
		node: {
			id: this_Show.id
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	CALL {
		WITH edges
		UNWIND edges AS edge
		WITH edge LIMIT $this_connection_showsConnectionparam0
		RETURN collect(edge) AS this_connection_showsConnectionvar1
	}
	WITH this_connection_showsConnectionvar1 AS edges, totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_showsConnection
}
RETURN this {
	.name,
	showsConnection: this_showsConnection
} AS this
----

'''

=== should limit the connection field level query

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
    actorsConnection {
      edges {
        node {
          id
        }
      }
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": {
    "low": 3,
    "high": 0
  },
  "this_connection_actorsConnectionparam0": {
    "low": 2,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * LIMIT $param0
CALL {
	WITH this
	MATCH (this)<-[this_connection_actorsConnectionthis0:ACTED_IN]-(this_Person:Person)
	WITH {
		node: {
			id: this_Person.id
		}
	} AS edge
	WITH collect(edge) AS edges
	WITH edges, size(edges) AS totalCount
	CALL {
		WITH edges
		UNWIND edges AS edge
		WITH edge LIMIT $this_connection_actorsConnectionparam0
		RETURN collect(edge) AS this_connection_actorsConnectionvar1
	}
	WITH this_connection_actorsConnectionvar1 AS edges, totalCount
	RETURN {
		edges: edges,
		totalCount: totalCount
	} AS this_actorsConnection
}
RETURN this {
	.id,
	actorsConnection: this_actorsConnection
} AS this
----

'''

=== should limit the normal field level query

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
    actors {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": {
    "low": 3,
    "high": 0
  },
  "param1": {
    "low": 2,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * LIMIT $param0
CALL {
	WITH this
	MATCH (this_actors:Person)-[this0:ACTED_IN]->(this)
	WITH this_actors {
		.id
	} AS this_actors LIMIT $param1
	RETURN collect(this_actors) AS this_actors
}
RETURN this {
	.id,
	actors: this_actors
} AS this
----

'''

=== should limit the relationship field level query

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
    actors {
      id
    }
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": {
    "low": 3,
    "high": 0
  },
  "param1": {
    "low": 2,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * LIMIT $param0
CALL {
	WITH this
	MATCH (this_actors:Person)-[this0:ACTED_IN]->(this)
	WITH this_actors {
		.id
	} AS this_actors LIMIT $param1
	RETURN collect(this_actors) AS this_actors
}
RETURN this {
	.id,
	actors: this_actors
} AS this
----

'''


== Top Level Query Limits

=== should limit the top level query with default value

.GraphQL-Query
[source,graphql]
----
{
  movies {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": {
    "low": 3,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Movie)
WITH * LIMIT $param0
RETURN this {
	.id
} AS this
----

'''

=== should limit the top level query with max value if not default is available

.GraphQL-Query
[source,graphql]
----
{
  shows {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": {
    "low": 2,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Show)
WITH * LIMIT $param0
RETURN this {
	.id
} AS this
----

'''

=== should limit the top level query with max value the option given is higher

.GraphQL-Query
[source,graphql]
----
{
  shows(options: {limit: 5}) {
    id
  }
}
----

.Expected Cypher params
[source,json]
----
{
  "param0": {
    "low": 2,
    "high": 0
  }
}
----

.Expected Cypher output
[source,cypher]
----
MATCH (this:Show)
WITH * LIMIT $param0
RETURN this {
	.id
} AS this
----

'''


